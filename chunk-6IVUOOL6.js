import{a as J,b as O,c as Y}from"./chunk-X2NQMOGB.js";import{f as H}from"./chunk-7CCD7PYX.js";import{a as W,b as j,e as B,f as Q,g as q}from"./chunk-KSVBKDBG.js";import{$a as d,Cb as V,Fb as A,Ga as F,Kb as z,P as y,Qa as D,Ra as G,U as x,Ua as k,V as _,Va as w,_a as s,ab as f,bb as C,d as X,fa as E,ga as I,gb as M,hb as h,lb as $,mb as P,nb as N,pb as T,qb as u,sb as S,tb as R,va as p,za as L}from"./chunk-BNKUSFLV.js";var g=X(Y());var Z=["mapContainer"],K=(n,t)=>t.key;function ee(n,t){if(n&1){let e=C();s(0,"button",13),M("click",function(){let l=x(e).$implicit,o=h();return _(o.toggleType(l.key))}),f(1,"span",14),u(2),d()}if(n&2){let e=t.$implicit,i=h();T(i.selectedTypes().has(e.key)?"bg-white shadow-sm border border-slate-200 text-slate-700":"bg-slate-100 text-slate-400 line-through"),p(),N("background-color",e.color),p(),S(" ",e.label," ")}}function te(n,t){if(n&1){let e=C();s(0,"button",15),M("click",function(){let l=x(e).$implicit,o=h();return _(o.selectedPeriod.set(l.key))}),u(1),d()}if(n&2){let e=t.$implicit,i=h();T(i.selectedPeriod()===e.key?"bg-white shadow-sm text-slate-700":"text-slate-400 hover:text-slate-600"),p(),S(" ",e.label," ")}}function ie(n,t){n&1&&(s(0,"div",9),f(1,"div",16),s(2,"span",17),u(3,"Chargement des activit\xE9s..."),d()())}var U=class n{strava=y(z);router=y(H);mapContainer=A("mapContainer");map=null;popup=new g.default.Popup({closeButton:!1,closeOnClick:!1,maxWidth:"280px"});hoveredId=null;activityTypes=[{key:"Run",label:"Course",color:"#ef4444"},{key:"TrailRun",label:"Trail",color:"#dc2626"},{key:"Ride",label:"V\xE9lo",color:"#3b82f6"},{key:"VirtualRide",label:"V\xE9lo virtuel",color:"#60a5fa"},{key:"Hike",label:"Randonn\xE9e",color:"#22c55e"},{key:"Walk",label:"Marche",color:"#84cc16"},{key:"Swim",label:"Natation",color:"#06b6d4"},{key:"Workout",label:"Entra\xEEnement",color:"#f59e0b"}];selectedTypes=E(new Set(this.activityTypes.map(t=>t.key)));periods=[{key:"all",label:"Tout"},{key:"12m",label:"12 mois"},{key:"6m",label:"6 mois"},{key:"3m",label:"3 mois"}];selectedPeriod=E("all");filteredActivities=V(()=>{let t=this.selectedTypes(),e=this.selectedPeriod(),i=this.strava.activities().filter(l=>t.has(l.type));if(e!=="all"){let l=parseInt(e),o=new Date;o.setMonth(o.getMonth()-l),i=i.filter(v=>new Date(v.start_date)>=o)}return i});toggleType(t){let e=new Set(this.selectedTypes());e.has(t)?e.delete(t):e.add(t),this.selectedTypes.set(e)}constructor(){L(()=>{this.strava.activities().length===0&&this.strava.loadActivities(1,200)}),I(()=>{let t=this.filteredActivities(),e=this.mapContainer();e&&t.length>0&&this.initMap(e.nativeElement,t)})}initMap(t,e){this.map&&this.map.remove();let i=e.find(o=>o.start_latlng),l=i?.start_latlng?[i.start_latlng[1],i.start_latlng[0]]:[2.3522,48.8566];this.map=new g.default.Map({container:t,style:"https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",center:l,zoom:10}),this.map.on("load",()=>{let o=new g.default.LngLatBounds,v=[];e.forEach((a,m)=>{let c=a.map?.summary_polyline;if(!c)return;let r=O(J(c));r.length!==0&&(r.forEach(b=>o.extend(b)),v.push({type:"Feature",id:m,properties:{name:a.name,type:a.type,color:Q(a.type),distance:a.distance,moving_time:a.moving_time,total_elevation_gain:a.total_elevation_gain,start_date:a.start_date,activityId:a.id},geometry:{type:"LineString",coordinates:r}}))}),v.length!==0&&(this.map.addSource("activities",{type:"geojson",data:{type:"FeatureCollection",features:v}}),this.map.addLayer({id:"activities-line",type:"line",source:"activities",paint:{"line-color":["get","color"],"line-width":["case",["boolean",["feature-state","hover"],!1],5,2.5],"line-opacity":["case",["boolean",["feature-state","hover"],!1],1,.2]}}),this.map.on("mousemove","activities-line",a=>{let m=a.features?.[0];if(!m)return;this.map.getCanvas().style.cursor="pointer";let c=m.id;this.hoveredId!==null&&this.hoveredId!==c&&this.map.setFeatureState({source:"activities",id:this.hoveredId},{hover:!1}),this.hoveredId!==c&&(this.hoveredId=c,this.map.setFeatureState({source:"activities",id:c},{hover:!0}));let r=m.properties,b=`
          <div style="font-family: system-ui, sans-serif; line-height: 1.4;">
            <div style="font-weight: 700; font-size: 13px; margin-bottom: 4px;">${r.name}</div>
            <div style="font-size: 11px; color: #64748b; margin-bottom: 6px;">${q(r.type)} \xB7 ${B(r.start_date)}</div>
            <div style="display: flex; gap: 12px; font-size: 12px;">
              <span><strong>${W(r.distance)}</strong> km</span>
              <span><strong>${j(r.moving_time)}</strong></span>
              <span><strong>${Math.round(r.total_elevation_gain)}</strong> m D+</span>
            </div>
          </div>
        `;this.popup.setLngLat(a.lngLat).setHTML(b).addTo(this.map)}),this.map.on("mouseleave","activities-line",()=>{this.map.getCanvas().style.cursor="",this.hoveredId!==null&&(this.map.setFeatureState({source:"activities",id:this.hoveredId},{hover:!1}),this.hoveredId=null),this.popup.remove()}),this.map.on("click","activities-line",a=>{let m=a.features?.[0]?.properties?.activityId;m&&this.router.navigate(["/activities",m],{queryParams:{from:"map"}})}),this.map.fitBounds(o,{padding:50}))})}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=F({type:n,selectors:[["app-global-map"]],viewQuery:function(e,i){e&1&&$(i.mapContainer,Z,5),e&2&&P()},decls:17,vars:3,consts:[["mapContainer",""],[1,"max-w-7xl","mx-auto","px-6","py-8"],[1,"text-3xl","font-bold","text-slate-800","tracking-tight","mb-6"],[1,"bg-white/80","backdrop-blur-sm","rounded-2xl","shadow-sm","border","border-slate-200/60","p-4","mb-6","flex","flex-wrap","gap-4","items-center"],[1,"flex","gap-1.5","flex-wrap"],[1,"flex","items-center","gap-1.5","px-3","py-1.5","rounded-lg","text-xs","font-semibold","transition-all",3,"class"],[1,"w-px","h-6","bg-slate-200","hidden","sm:block"],[1,"flex","gap-1","bg-slate-100","rounded-lg","p-0.5"],[1,"px-3","py-1.5","rounded-md","text-xs","font-semibold","transition-all",3,"class"],[1,"text-center","py-6"],[1,"bg-white/80","backdrop-blur-sm","rounded-2xl","shadow-sm","border","border-slate-200/60","overflow-hidden"],[1,"h-[600px]","w-full"],[1,"text-sm","text-slate-400","mt-3","text-right","font-medium"],[1,"flex","items-center","gap-1.5","px-3","py-1.5","rounded-lg","text-xs","font-semibold","transition-all",3,"click"],[1,"w-2.5","h-2.5","rounded-full","inline-block"],[1,"px-3","py-1.5","rounded-md","text-xs","font-semibold","transition-all",3,"click"],[1,"inline-block","h-8","w-8","animate-spin","rounded-full","border-4","border-strava","border-r-transparent"],[1,"ml-3","text-slate-400","font-medium"]],template:function(e,i){e&1&&(s(0,"div",1)(1,"h1",2),u(2,"Carte des activit\xE9s"),d(),s(3,"div",3)(4,"div",4),k(5,ee,3,5,"button",5,K),d(),f(7,"span",6),s(8,"div",7),k(9,te,2,3,"button",8,K),d()(),D(11,ie,4,0,"div",9),s(12,"div",10),f(13,"div",11,0),d(),s(15,"p",12),u(16),d()()),e&2&&(p(5),w(i.activityTypes),p(4),w(i.periods),p(2),G(i.strava.loading()?11:-1),p(5),R(" ",i.filteredActivities().length," / ",i.strava.activitiesCount()," activit\xE9s affich\xE9es "))},encapsulation:2})};export{U as GlobalMap};
