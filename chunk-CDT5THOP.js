import{a as j,b as ue}from"./chunk-UR74UJFY.js";import{a as ge,b as xe,c as fe}from"./chunk-PMES5ZO4.js";import{a as de,b as ce,c as V,d as $,e as me,f as q,h as pe}from"./chunk-KSVBKDBG.js";import{b as oe,d as re,g as le}from"./chunk-YE3AVIY2.js";import{Bb as R,Db as ae,Eb as H,Ga as O,Jb as se,P as W,Qa as x,Ra as h,Ta as U,U as I,Ua as X,V as L,Va as Y,W as J,Wa as a,Xa as n,Ya as E,ab as P,d as ve,eb as B,fa as y,ga as N,gb as u,kb as ee,lb as te,mb as ie,ob as F,pb as l,qb as g,rb as w,sb as ne,va as r,xb as S,yb as D,za as Z}from"./chunk-U5O3G23B.js";var K=ve(fe());var be=["mapContainer"],_e=["splitsChart"],Ce=["analysisChart"],ye=(o,t)=>t.lap_index;function we(o,t){o&1&&(a(0,"div",4),E(1,"div",9),a(2,"p",10),l(3,"Chargement de l'activit\xE9..."),n()())}function Se(o,t){if(o&1&&(a(0,"p",18),l(1),n()),o&2){let e=u();r(),g(e.description)}}function De(o,t){if(o&1&&(a(0,"p",29),l(1),S(2,"number"),n()),o&2){let e=u(2);r(),w("max ",D(2,1,e.max_heartrate,"1.0-0"))}}function Ee(o,t){if(o&1&&(a(0,"div",24)(1,"p",27),l(2),S(3,"number"),n(),a(4,"p",28),l(5,"FC moy."),n(),x(6,De,3,4,"p",29),n()),o&2){let e=u();r(2),g(D(3,2,e.average_heartrate,"1.0-0")),r(4),h(e.max_heartrate?6:-1)}}function ke(o,t){if(o&1&&(a(0,"div",25)(1,"p",27),l(2),S(3,"number"),S(4,"number"),n(),a(5,"p",28),l(6),n()()),o&2){let e=u(),i=u();r(2),g(i.isRunning()?D(3,2,e.average_cadence*2,"1.0-0"):D(4,5,e.average_cadence,"1.0-0")),r(4),g(i.isRunning()?"Cadence (ppm)":"Cadence (rpm)")}}function Me(o,t){if(o&1&&(a(0,"p",29),l(1),S(2,"number"),S(3,"number"),n()),o&2){let e=u();r(),ne("",D(2,2,e.elev_low,"1.0-0")," - ",D(3,5,e.elev_high,"1.0-0")," m")}}function Ae(o,t){if(o&1&&(a(0,"div",30)(1,"p",27),l(2),S(3,"number"),n(),a(4,"p",28),l(5,"Calories"),n()()),o&2){let e=u();r(2),g(D(3,1,e.calories,"1.0-0"))}}function Re(o,t){o&1&&(a(0,"div",34),E(1,"div",37),a(2,"p",38),l(3,"Chargement de l'analyse..."),n()())}function Te(o,t){if(o&1){let e=P();a(0,"button",43),B("click",function(){I(e);let s=u(3);return L(s.showHeartrate.set(!s.showHeartrate()))}),l(1," FC "),n()}if(o&2){let e=u(3);F(e.showHeartrate()?"bg-rose-500 text-white shadow-sm":"bg-slate-100 text-slate-500 hover:bg-slate-200")}}function Ie(o,t){if(o&1){let e=P();a(0,"button",43),B("click",function(){I(e);let s=u(3);return L(s.showCadence.set(!s.showCadence()))}),l(1," Cadence "),n()}if(o&2){let e=u(3);F(e.showCadence()?"bg-violet-500 text-white shadow-sm":"bg-slate-100 text-slate-500 hover:bg-slate-200")}}function Le(o,t){if(o&1){let e=P();a(0,"div",35)(1,"div",39)(2,"h2",40),l(3,"Analyse"),n(),a(4,"div",41),x(5,Te,2,2,"button",42),a(6,"button",43),B("click",function(){I(e);let s=u(2);return L(s.showPace.set(!s.showPace()))}),l(7),n(),x(8,Ie,2,2,"button",42),n()(),E(9,"canvas",null,1),n()}if(o&2){let e=u(2);r(5),h(e.hasStream("heartrate")?5:-1),r(),F(e.showPace()?"bg-blue-500 text-white shadow-sm":"bg-slate-100 text-slate-500 hover:bg-slate-200"),r(),w(" ",e.isRunning()?"Allure":"Vitesse"," "),r(),h(e.hasStream("cadence")?8:-1)}}function Ne(o,t){o&1&&(a(0,"div",34),E(1,"div",37),a(2,"p",38),l(3,"Chargement des splits..."),n()())}function Pe(o,t){o&1&&(a(0,"th",50),l(1,"FC"),n())}function Be(o,t){if(o&1&&(a(0,"td",53),l(1),S(2,"number"),n()),o&2){let e=u().$implicit;r(),g(D(2,1,e.average_heartrate,"1.0-0"))}}function Fe(o,t){if(o&1&&(a(0,"tr",51)(1,"td",52),l(2),n(),a(3,"td",53),l(4),n(),a(5,"td",54),l(6),n(),a(7,"td",53),l(8),S(9,"number"),n(),a(10,"td",53),l(11),n(),x(12,Be,3,4,"td",53),n()),o&2){let e=t.$implicit,i=t.$index,s=u(3);r(2),g(i+1),r(2),w("",s.formatLapDistance(e.distance)," km"),r(2),w(" ",s.formatLapPace(e)," "),r(2),w("",D(9,6,e.total_elevation_gain,"1.0-0")," m"),r(3),g(s.formatDuration(e.moving_time)),r(),h(s.laps()[0].average_heartrate?12:-1)}}function He(o,t){if(o&1&&(a(0,"div",36)(1,"div",44)(2,"h2",45),l(3),n(),E(4,"canvas",null,2),n(),a(6,"div",46)(7,"h2",45),l(8,"D\xE9tails des splits"),n(),a(9,"table",47)(10,"thead")(11,"tr",48)(12,"th",49),l(13,"Split"),n(),a(14,"th",50),l(15,"Dist."),n(),a(16,"th",50),l(17),n(),a(18,"th",50),l(19,"D+"),n(),a(20,"th",50),l(21,"Dur\xE9e"),n(),x(22,Pe,2,0,"th",50),n()(),a(23,"tbody"),U(24,Fe,13,9,"tr",51,ye),n()()()()),o&2){let e=u(2);r(3),w(" ",e.isRunning()?"Allure par split":"Vitesse par split"," "),r(14),w(" ",e.isRunning()?"Allure":"Vitesse"," "),r(5),h(e.laps()[0].average_heartrate?22:-1),r(2),X(e.laps())}}function Ve(o,t){if(o&1&&(a(0,"div",11)(1,"div",12)(2,"span",13),l(3),n(),a(4,"div")(5,"div",14)(6,"h1",15),l(7),n(),a(8,"span",16),l(9),n()(),a(10,"p",17),l(11),n()()(),x(12,Se,2,1,"p",18),n(),a(13,"div",19)(14,"div",20)(15,"p",21),l(16),n(),a(17,"p",22),l(18,"Distance"),n()(),a(19,"div",20)(20,"p",21),l(21),n(),a(22,"p",22),l(23,"Dur\xE9e"),n()(),a(24,"div",20)(25,"p",21),l(26),n(),a(27,"p",22),l(28),n()(),a(29,"div",20)(30,"p",21),l(31),n(),a(32,"p",22),l(33),n()()(),a(34,"div",23),x(35,Ee,7,5,"div",24),x(36,ke,7,8,"div",25),a(37,"div",26)(38,"p",27),l(39),S(40,"number"),n(),a(41,"p",28),l(42,"D\xE9nivel\xE9 D+"),n(),x(43,Me,4,8,"p",29),n(),x(44,Ae,6,4,"div",30),n(),a(45,"div",31)(46,"h2",32),l(47,"Trac\xE9 GPS"),n(),E(48,"div",33,0),n(),x(50,Re,4,0,"div",34),x(51,Le,11,5,"div",35),x(52,Ne,4,0,"div",34),x(53,He,26,3,"div",36)),o&2){let e=t,i=u();r(3),g(i.getIcon(e.type)),r(4),g(e.name),r(),ie("background-color",i.getColor(e.type)),r(),w(" ",e.type," "),r(2),g(i.formatDate(e.start_date)),r(),h(e.description?12:-1),r(4),g(i.formatDistance(e.distance)),r(5),g(i.formatDuration(e.moving_time)),r(5),g(i.formatSpeed(e)),r(2),g(i.isRunning()?"Allure moy.":"Vitesse moy."),r(3),g(i.formatMaxSpeed(e)),r(2),g(i.isRunning()?"Allure max.":"Vitesse max."),r(2),h(e.average_heartrate?35:-1),r(),h(e.average_cadence?36:-1),r(3),w("",D(40,22,e.total_elevation_gain,"1.0-0")," m"),r(4),h(e.elev_high!=null&&e.elev_low!=null?43:-1),r(),h(e.calories?44:-1),r(6),h(i.streamsLoading()?50:-1),r(),h(i.streams().length>0?51:-1),r(),h(i.lapsLoading()?52:-1),r(),h(i.laps().length>1?53:-1)}}j.register(...ue);var he=class o{strava=W(se);route=W(re);id=ae.required();fromPage=y(null);backRoute=R(()=>{let t=this.fromPage();return t==="map"?"/map":t==="progression"?"/progression":"/activities"});backLabel=R(()=>{let t=this.fromPage();return t==="map"?"Retour \xE0 la carte":t==="progression"?"Retour \xE0 la progression":"Retour aux activit\xE9s"});activity=y(null);loading=y(!1);laps=y([]);lapsLoading=y(!1);streams=y([]);streamsLoading=y(!1);showHeartrate=y(!1);showPace=y(!1);showCadence=y(!1);isRunning=R(()=>{let t=this.activity()?.type;return t==="Run"||t==="TrailRun"});mapContainer=H("mapContainer");splitsCanvas=H("splitsChart");analysisCanvas=H("analysisChart");map=null;splitsChart=null;analysisChart=null;splitsData=R(()=>{let t=this.laps(),e=this.isRunning();if(t.length<=1)return null;let i=t.map((m,C)=>`${C+1}`),s=t.map(m=>e?m.average_speed>0?1e3/m.average_speed/60:0:m.average_speed*3.6),c=s.reduce((m,C)=>m+C,0)/s.length,_=s.map(m=>e?m<=c?"#22c55e99":"#ef444499":m>=c?"#22c55e99":"#ef444499");return{labels:i,paces:s,colors:_,avgPace:c,isRunning:e}});constructor(){this.fromPage.set(this.route.snapshot.queryParamMap.get("from")),Z(()=>{this.loadActivity()}),N(()=>{let t=this.activity(),e=this.mapContainer();t&&e&&this.initMap(e.nativeElement,t)}),N(()=>{let t=this.splitsCanvas(),e=this.splitsData();t&&e&&this.renderSplitsChart(t,e)}),N(()=>{let t=this.analysisCanvas(),e=this.streams(),i=this.showHeartrate(),s=this.showPace(),c=this.showCadence(),_=this.isRunning();t&&e.length>0&&this.renderAnalysisChart(t,e,{hr:i,pace:s,cadence:c,running:_})})}async loadActivity(){this.loading.set(!0);let t=await this.strava.getActivityDetail(Number(this.id()));if(this.activity.set(t),this.loading.set(!1),t){this.lapsLoading.set(!0),this.streamsLoading.set(!0);let[e,i]=await Promise.all([this.strava.getActivityLaps(t.id),this.strava.getActivityStreams(t.id)]);this.laps.set(e),this.lapsLoading.set(!1),this.streams.set(i),this.streamsLoading.set(!1)}}initMap(t,e){this.map&&this.map.remove();let i=e.map.polyline||e.map.summary_polyline;if(!i)return;let s=xe(ge(i));s.length!==0&&(this.map=new K.default.Map({container:t,style:"https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",center:s[0],zoom:13}),this.map.on("load",()=>{this.map.addSource("route",{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:s}}}),this.map.addLayer({id:"route-line",type:"line",source:"route",paint:{"line-color":q(e.type),"line-width":4,"line-opacity":.8}});let c=s.reduce((_,m)=>_.extend(m),new K.default.LngLatBounds(s[0],s[0]));this.map.fitBounds(c,{padding:50})}))}renderSplitsChart(t,e){this.splitsChart&&this.splitsChart.destroy();let i=e.isRunning?"min/km":"km/h";this.splitsChart=new j(t.nativeElement,{type:"bar",data:{labels:e.labels,datasets:[{label:i,data:e.paces.map(s=>Math.round(s*100)/100),backgroundColor:e.colors,borderRadius:6,borderSkipped:!1}]},options:{responsive:!0,plugins:{legend:{display:!1},tooltip:{backgroundColor:"#1B1F3B",padding:12,cornerRadius:8,callbacks:{label:s=>{let c=s.parsed.y??0;if(e.isRunning){let _=Math.floor(c),m=Math.round((c-_)*60);return` ${_}'${m.toString().padStart(2,"0")}" /km`}return` ${c.toFixed(1)} km/h`}}}},scales:{y:{beginAtZero:!1,reverse:e.isRunning,title:{display:!0,text:i,color:"#94a3b8"},grid:{color:"#f1f5f9"},ticks:{color:"#94a3b8"}},x:{title:{display:!0,text:"Split",color:"#94a3b8"},grid:{display:!1},ticks:{color:"#94a3b8"}}}}})}formatDistance(t){return de(t)}formatDuration(t){return ce(t)}formatDate(t){return me(t)}getIcon(t){return pe(t)}getColor(t){return q(t)}formatLapDistance(t){return(t/1e3).toFixed(2)}formatLapPace(t){return this.isRunning()?V(t.average_speed):$(t.average_speed)+" km/h"}formatSpeed(t){return t.type==="Run"||t.type==="TrailRun"?V(t.average_speed):$(t.average_speed)+" km/h"}formatMaxSpeed(t){return t.type==="Run"||t.type==="TrailRun"?V(t.max_speed):$(t.max_speed)+" km/h"}hasStream(t){return this.streams().some(e=>e.type===t)}getStreamData(t){return this.streams().find(e=>e.type===t)?.data??[]}smooth(t,e=10){let i=Math.floor(e/2);return t.map((s,c)=>{let _=Math.max(0,c-i),m=Math.min(t.length,c+i+1),C=0,k=0;for(let M=_;M<m;M++)isNaN(t[M])||(C+=t[M],k++);return k>0?C/k:NaN})}dataRange(t){let e=1/0,i=-1/0;for(let c of t)isNaN(c)||(c<e&&(e=c),c>i&&(i=c));let s=i-e||1;return{min:e,max:i,range:s}}renderAnalysisChart(t,e,i){this.analysisChart&&this.analysisChart.destroy();let s=this.getStreamData("distance"),c=this.getStreamData("altitude");if(s.length===0||c.length===0)return;let _=Math.max(1,Math.floor(s.length/500)),m=d=>d.filter((p,v)=>v%_===0),C=m(s).map(d=>d/1e3),k=m(c),M=Math.min(...k),Q=Math.max(...k),z=Q-M||1,A=[];A.push({label:"Altitude (m)",data:C.map((d,p)=>({x:d,y:k[p]})),borderColor:"rgba(148, 163, 184, 0.6)",backgroundColor:"rgba(148, 163, 184, 0.3)",fill:"origin",tension:.3,pointRadius:0,borderWidth:1.5,yAxisID:"yAlt",order:10});let T={x:{type:"linear",display:!0,title:{display:!1},grid:{display:!1},ticks:{color:"#94a3b8",maxTicksLimit:15,callback:d=>`${d} km`}},yAlt:{type:"linear",position:"left",suggestedMin:Math.floor(M-z*.1),suggestedMax:Math.ceil(Q+z*.05),title:{display:!1},grid:{color:"#f1f5f9"},ticks:{color:"#94a3b8",callback:d=>`${Math.round(d)} m`}}};if(i.hr){let d=m(this.getStreamData("heartrate"));if(d.length>0){let p=this.smooth(d),v=this.dataRange(p);A.push({label:"FC (bpm)",data:C.map((f,b)=>({x:f,y:p[b]})),borderColor:"#ef4444",backgroundColor:"transparent",tension:.4,pointRadius:0,borderWidth:1.5,yAxisID:"yHr",order:1}),T.yHr={type:"linear",display:!1,min:v.min-v.range*1.5,max:v.max+v.range*.1}}}if(i.pace){let d=m(this.getStreamData("velocity_smooth"));if(d.length>0){let p=d.map(b=>b<=1?NaN:i.running?Math.min(1e3/b/60,15):b*3.6),v=this.smooth(p),f=this.dataRange(v);A.push({label:i.running?"Allure (min/km)":"Vitesse (km/h)",data:C.map((b,G)=>({x:b,y:v[G]})),borderColor:"#3b82f6",backgroundColor:"transparent",tension:.4,pointRadius:0,borderWidth:1.5,yAxisID:"yPace",spanGaps:!0,order:2}),T.yPace={type:"linear",display:!1,reverse:i.running,min:f.min-f.range*.1,max:f.max+f.range*1.5}}}if(i.cadence){let d=m(this.getStreamData("cadence"));if(d.length>0){let p=d.map(b=>b===0?NaN:i.running?b*2:b),v=this.smooth(p),f=this.dataRange(v);A.push({label:i.running?"Cadence (ppm)":"Cadence (rpm)",data:C.map((b,G)=>({x:b,y:v[G]})),borderColor:"#8b5cf6",backgroundColor:"transparent",tension:.4,pointRadius:0,borderWidth:1.5,yAxisID:"yCad",spanGaps:!0,order:3}),T.yCad={type:"linear",display:!1,min:f.min-f.range*.8,max:f.max+f.range*.8}}}this.analysisChart=new j(t.nativeElement,{type:"line",data:{datasets:A},options:{responsive:!0,interaction:{mode:"index",intersect:!1},plugins:{legend:{position:"bottom",labels:{padding:16,usePointStyle:!1,boxWidth:30,boxHeight:2,color:"#64748b",font:{size:12}}},tooltip:{backgroundColor:"#1B1F3B",titleFont:{weight:"bold"},padding:12,cornerRadius:8,callbacks:{title:d=>{let p=d[0]?.parsed?.x;return p!=null?`${p.toFixed(1)} km`:""},label:d=>{let p=d.parsed.y;if(p==null||isNaN(p))return"";if(d.dataset.yAxisID==="yPace"&&i.running){let v=Math.floor(p),f=Math.round((p-v)*60);return` Allure : ${v}:${f.toString().padStart(2,"0")} /km`}return` ${d.dataset.label} : ${Math.round(p)}`}}}},scales:T}})}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=O({type:o,selectors:[["app-activity-detail"]],viewQuery:function(e,i){e&1&&ee(i.mapContainer,be,5)(i.splitsCanvas,_e,5)(i.analysisCanvas,Ce,5),e&2&&te(3)},inputs:{id:[1,"id"]},decls:8,vars:4,consts:[["mapContainer",""],["analysisChart",""],["splitsChart",""],[1,"max-w-7xl","mx-auto","px-6","py-8"],[1,"text-center","py-16"],[1,"mt-8"],[1,"inline-flex","items-center","gap-2","text-strava","hover:text-strava-dark","font-semibold","transition-colors",3,"routerLink"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-4","h-4"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M15 19l-7-7 7-7"],[1,"inline-block","h-10","w-10","animate-spin","rounded-full","border-4","border-strava","border-r-transparent"],[1,"mt-3","text-slate-400","font-medium"],[1,"mb-8"],[1,"flex","items-center","gap-4","mb-3"],[1,"text-3xl","w-14","h-14","flex","items-center","justify-center","rounded-2xl","bg-white","shadow-sm","border","border-slate-200/60"],[1,"flex","items-center","gap-3"],[1,"text-3xl","font-bold","text-slate-800","tracking-tight"],[1,"text-sm","font-semibold","px-3","py-1","rounded-full","text-white","shadow-sm"],[1,"text-slate-400","mt-1"],[1,"text-slate-500","mt-2","pl-18"],[1,"grid","grid-cols-2","md:grid-cols-4","gap-4","mb-4"],[1,"bg-white/80","backdrop-blur-sm","rounded-2xl","shadow-sm","border","border-slate-200/60","p-5","text-center","hover:shadow-md","transition-shadow"],[1,"text-3xl","font-extrabold","text-slate-800"],[1,"text-xs","font-semibold","text-slate-400","uppercase","tracking-wider","mt-1"],[1,"grid","grid-cols-2","md:grid-cols-4","gap-4","mb-8"],[1,"bg-gradient-to-br","from-rose-500","to-red-500","rounded-2xl","shadow-lg","shadow-rose-500/20","p-5","text-center","text-white"],[1,"bg-gradient-to-br","from-indigo-500","to-violet-600","rounded-2xl","shadow-lg","shadow-indigo-500/20","p-5","text-center","text-white"],[1,"bg-gradient-to-br","from-emerald-500","to-teal-600","rounded-2xl","shadow-lg","shadow-emerald-500/20","p-5","text-center","text-white"],[1,"text-3xl","font-extrabold"],[1,"text-xs","font-semibold","uppercase","tracking-wider","mt-1","opacity-80"],[1,"text-sm","font-bold","mt-1","opacity-70"],[1,"bg-gradient-to-br","from-orange-500","to-amber-500","rounded-2xl","shadow-lg","shadow-orange-500/20","p-5","text-center","text-white"],[1,"bg-white/80","backdrop-blur-sm","rounded-2xl","shadow-sm","border","border-slate-200/60","overflow-hidden"],[1,"text-base","font-semibold","text-slate-700","p-5","pb-0"],[1,"h-[500px]","w-full","mt-3"],[1,"mt-6","text-center","py-8"],[1,"mt-6","bg-white/80","backdrop-blur-sm","rounded-2xl","shadow-sm","border","border-slate-200/60","p-6"],[1,"mt-6","grid","grid-cols-1","lg:grid-cols-2","gap-6"],[1,"inline-block","h-8","w-8","animate-spin","rounded-full","border-4","border-strava","border-r-transparent"],[1,"mt-2","text-slate-400","text-sm","font-medium"],[1,"flex","flex-wrap","items-center","justify-between","gap-3","mb-4"],[1,"text-base","font-semibold","text-slate-700"],[1,"flex","gap-2"],[1,"px-3","py-1.5","rounded-lg","text-xs","font-semibold","transition-all",3,"class"],[1,"px-3","py-1.5","rounded-lg","text-xs","font-semibold","transition-all",3,"click"],[1,"bg-white/80","backdrop-blur-sm","rounded-2xl","shadow-sm","border","border-slate-200/60","p-6"],[1,"text-base","font-semibold","text-slate-700","mb-4"],[1,"bg-white/80","backdrop-blur-sm","rounded-2xl","shadow-sm","border","border-slate-200/60","p-6","overflow-auto"],[1,"w-full","text-sm"],[1,"border-b","border-slate-200"],[1,"text-left","py-2","px-2","text-xs","font-semibold","text-slate-400","uppercase","tracking-wider"],[1,"text-right","py-2","px-2","text-xs","font-semibold","text-slate-400","uppercase","tracking-wider"],[1,"border-b","border-slate-100","hover:bg-slate-50/50","transition-colors"],[1,"py-2.5","px-2","font-semibold","text-slate-700"],[1,"py-2.5","px-2","text-right","text-slate-600"],[1,"py-2.5","px-2","text-right","font-semibold","text-slate-800"]],template:function(e,i){if(e&1&&(a(0,"div",3),x(1,we,4,0,"div",4),x(2,Ve,54,25),a(3,"div",5)(4,"a",6),J(),a(5,"svg",7),E(6,"path",8),n(),l(7),n()()()),e&2){let s;r(),h(i.loading()?1:-1),r(),h((s=i.activity())?2:-1,s),r(2),Y("routerLink",i.backRoute()),r(3),w(" ",i.backLabel()," ")}},dependencies:[le,oe],encapsulation:2})};export{he as ActivityDetailComponent};
